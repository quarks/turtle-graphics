/*
 Turtle-Graphics    (c) Peter Lager  2025
 @license MIT
 @version 1.0.0
*/
const [DISPLAY,STANDARD,LOGO]=[Symbol.for("display"),Symbol.for("standard"),Symbol.for("logo")],[BUTT,SQUARE,ROUND]=[Symbol.for("butt"),Symbol.for("square"),Symbol.for("round")],[STYLE,POS,STYLE_POS]=[1,2,3],[LT,CT,RT,JT]=[-1,0,1,2],[TG]=function(){const {PI:e,abs:q,atan2:f,ceil:g,cos:h,max:m,sign:n,sin:r,sqrt:l,atan:x}=Math,[y,v]=[Math.PI/2,2*Math.PI],A=(a,b=v)=>{for(;0>a;)a+=b;for(;a>=b;)a-=b;return a},K=(a,b)=>{let d=(a-b)**2/(a+b)**2;return e*(a+b)*(1+3*d/(10+l(4-3*d)))},L=(a,b,d,k,p,t)=>{d*=
h(t);k*=r(t);t=Math.sin(p);p=Math.cos(p);return[a+d*p-k*t,b+k*p+d*t]},[N,W,D]=[1,-1,0],[F,O]=[0,1],[P,Q]=[1,-1],X=5*e,I=new Map;class E{static clearRecords(){I.clear()}static setRecord(a,b){I.set(a,b)}static hasRecord(a){return I.has(a)}static getRecord(a){if(E.hasRecord(a))return I.get(a).map(b=>b.clone())}static getTurtle(a,b,d){return new E(a,b,d)}constructor(a,b,d=DISPLAY,k=!0){this._b=new OffscreenCanvas(a,b);this._bdc=this._b.getContext("2d");this._interval=25;this._polygons=new Map;this._snapshots=
new Map;this._set_mode(d);this._degrees=k;this._earlier=this._timer=0;this._font="400 normal 14px sans-serif";this.setTurtle(DART);this._reset()}draw(a,b=0,d=0){let k=this._b.width,p=this._b.height,t=k/2,z=p/2;a.save();a.translate(b,d);a.beginPath();a.moveTo(-t,-z);a.lineTo(t,-z);a.lineTo(t,z);a.lineTo(-t,z);a.closePath();a.clip();switch(this._mode){case LOGO:a.rotate(-y);break;case STANDARD:a.scale(1,-1)}a.drawImage(this._b,0,0,k,p,-t,-z,k,p);this._penDown&&this._taskQueue[0]&&this._taskQueue[0].render&&
this._taskQueue[0].render(a);this._csrVisible&&(a.translate(this._penX,this._penY),a.rotate(isNaN(this._tilt)?this._penA:this._tilt),a.drawImage(this._cursor.icon,-this._cursor.hitX,-this._cursor.hitY));a.restore()}_getCopy(){let a=turtle._b,b=a.width,d=a.height,k=b/2,p=d/2,t=new OffscreenCanvas(a.width,a.height),z=t.getContext("2d");z.translate(a.width/2,a.height/2);switch(turtle._mode){case LOGO:z.rotate(-y);break;case STANDARD:z.scale(1,-1)}z.drawImage(a,0,0,b,d,-k,-p,b,d);return t}x(a,b=!1){return this._addTask(new J(F,
a,NaN,b))}y(a,b=!1){return this._addTask(new J(F,NaN,a,b))}xy(a,b,d=!1){return this._addTask(new J(F,a,b,d))}dxy(a,b,d=!1){return this._addTask(new J(O,a,b,d))}f(a){return this._addTask(new w("_penA",this._fix(a)))}face(a){return this.f(a)}fd(a){return this._addTask(new G(a,N))}forward(a){return this.fd(a)}bk(a){return this._addTask(new G(a,W))}backward(a){return this.bk(a)}back(a){return this.bk(a)}bend(a,b,d=RT,k=!0,p=0){return this._addTask(new Y(a,b,d,k,g(p)))}lt(a){return this._addTask(new C(this._fix(a),
LT))}left(a){return this.lt(a)}rt(a){return this._addTask(new C(this._fix(a),RT))}right(a){return this.rt(a)}head(a){return this._addTask(new C(this._fix(a),D))}heading(a){return this.head(a)}home(){return this._addTask(new Z)}goto(a,b){return this._addTask(new M(F,a,b))}goby(a,b){return this._addTask(new M(O,a,b))}dot(a=6,b="current",d=.5,k="current"){return this._addTask(new aa(a,b,d,k))}arrow(a=6,b="current",d=.5,k="current"){return this._addTask(new ba(a,b,d,k))}circle(a,b=0,d=RT,k=0){return this.oval(a,
a,b,d,k)}oval(a,b,d=0,k=RT,p=0){d=q(0===d?v:this._degrees?d*e/180:d);return 0===p?this._addTask(new R(a,b,d,k)):this._addTask(new S(a,b,d,k,g(p)))}sleep(a){return this._addTask(new ca(a))}write(a,b="left",d=!1,k){return this._addTask(new da(a,b,d,k))}font(a){return this._addTask(new w("_font",a))}up(){return this._addTask(new w("_penDown",!1))}pu(){return this.up()}penup(){return this.up()}down(){return this._addTask(new w("_penDown",!0))}pd(){return this.down()}pendown(){return this.down()}pensize(a=
2){return this._addTask(new w("_penSize",a))}dash(a=[],b=0){this._addTask(new w("_dash",a));this._addTask(new w("_dashOffset",b));return this}pendash(a=[]){return this.dash(a)}cap(a){return this._addTask(new w("_penCap",a))}pencap(a){return this.cap(a)}pencolor(a){return this._addTask(new w("_penColor",a))}fillcolor(a){return this._addTask(new w("_fillColor",a))}push_pen(){return this._addTask(new T(P))}pop_pen(a=STYLE_POS){return this._addTask(new T(Q,a))}turtle(a){return"Cursor"===a?.constructor?.name?
this._addTask(new w("_cursor",a)):this}st(){return this._addTask(new w("_csrVisible",!0))}showturtle(){return this.st()}ht(){return this._addTask(new w("_csrVisible",!1))}hideturtle(){return this.ht()}tilt(a){return this._addTask(new w("_tilt",this._fix(a)))}speed(a,b){isFinite(a)&&0<a&&this._addTask(new w("_lnrSpeed",a));isFinite(b)&&0<b&&this._addTask(new w("_angSpeed",this._degrees?b*e/180:b));return this}begin_fill(){return this._addTask(new U)}end_fill(a=!1){return this._addTask(new V(a))}begin_poly(){return this._addTask(new ea)}end_poly(a){return this._addTask(new fa(a))}begin_record(){return this._addTask(new ha)}end_record(a){return this._addTask(new ia(a))}do(a,
...b){return"Function"===a.constructor.name?this._addTask(new ja(a,b)):"string"===typeof a?this._addTask(new ka(a)):this}animateon(){return this._addTask(new w("_animate",!0))}animateoff(){return this._addTask(new w("_animate",!1))}clear(){return this._addTask(new la)}reset(){return this._addTask(new ma)}snapshot(a){return this._addTask(new na(a))}start(){this._startTurtle();this._autoStart=!0;return this}stop(){this._stopTurtle();this._autoStart=!1;return this}degrees(){this._degrees=!0}radians(){this._degrees=
!1}setUpdateInterval(a){this._interval=a}showTurtle(){this._csrVisible=!0;return this}hideTurtle(){this._csrVisible=!1;return this}doClear(){return this._clear()}doReset(){return this._reset()}getXY(){return this._p_m_XY(this._penX,this._penY)}getX(){return this._p_m_XY(this._penX,this._penY)[0]}getY(){return this._p_m_XY(this._penX,this._penY)[1]}getH(){return this._degrees?180*this._penA/e:this._penA}getHeading(){return this.getH()}setXYH(a,b,d){this.setXY(a,b);this.setH(d);return this}setXY(a,
b){Number.isFinite(a)&&Number.isFinite(b)&&(this._mode===LOGO?(this._penX=b,this._penY=a):(this._penX=a,this._penY=b));return this}setX(a){Number.isFinite(a)&&(this._mode===LOGO?this._penY=a:this._penX=a);return this}setY(a){Number.isFinite(a)&&(this._mode===LOGO?this._penX=a:this._penY=a);return this}setH(a){this._penA=this._degrees?a*e/180:a;return this}getScreenXY(a=0,b=0){return this._m_s_XY(this._penX,this._penY,a,b)}getScreenH(){return this._m_s_Angle(this.getH())}getModeXY(a,b,d=0,k=0){return this._s_m_XY(a,
b,d,k)}getModeH(a){return this._s_m_Angle(a)}setPenSize(a){this._penSize=a;return this}getPenSize(){return this._penSize}setDash(a=[]){Array.isArray(a)&&(this._dash=a);return this}getDash(){return this._dash}setPenColor(a){this._penColor=a;return this}getPenColor(){return this._penColor}setCap(a){this._penCap=a;return this}getCap(){return this._penCap}setFillColor(a){this._fillColor=a;return this}getFillColor(){return this._fillColor}setSpeed(a=NaN,b=NaN){Number.isNaN(a)||(this._lnrSpeed=a);Number.isNaN(b)||
(this._angSpeed=this.degrees?b*e/180:b);return this}getSpeed(){return[this._lnrSpeed,this._degrees?180*this._angSpeed/e:this._angSpeed]}getPoly(a){return this._polygons.get(a)}getSnapshot(a){return(a=this._snapshots.get(a))?a:this._getCopy()}setTurtle(a){a&&"string"===typeof a&&CURSORS.has(a)?this._cursor=CURSORS.get(a):"Cursor"===a?.constructor?.name&&(this._cursor=a);return this}setCursor(a){return this.setTurtle(a)}get hasTasks(){return 0<this.nbrTasks}get isActive(){return 0!=this._timer}get isAnimating(){return this._animate}get isVisible(){return this._csrVisible}get isPenDown(){return this._penDown}get isFilling(){return this._fill_track}get nbrTasks(){return this._taskQueue.length}get nbrStyles(){return this._penStack.length}get mode(){return this._mode}get mode$(){return Symbol.keyFor(this._mode)}get width(){return this._b.width}get height(){return this._b.height}get aspect(){return this._b.width/
this._b.height}spawn(){let a=new E(this._b.width,this._b.height,this._mode);for(let b of Object.keys(this))"object"!=typeof this[b]&&(a[b]=this[b]);a._dash=[...this._dash];a._cursor=this._cursor;a._poly_points=[];a._poly_track=!1;a._fill_points=[];a._fill_track=!1;a._timer=0;return a}_set_mode(a){switch(a){case LOGO:this._p_m_XY=function(b,d){return[d,b]};this._s_m_XY=function(b,d,k=0,p=0){return[b-k,p-d]};this._m_s_XY=function(b,d,k=0,p=0){return[k+d,p-b]};this._s_m_Angle=function(b){return this._norm(b+
(this._degrees?90:y))};this._m_s_Angle=function(b){return this._norm(b+(this._degrees?-90:-y))};this._mode=a;break;case STANDARD:this._p_m_XY=function(b,d){return[b,d]};this._s_m_XY=function(b,d,k=0,p=0){return[b-k,p-d]};this._m_s_XY=function(b,d,k=0,p=0){return[b+k,-d+p]};this._s_m_Angle=this._m_s_Angle=function(b){return this._norm(-b+(this._degrees?360:v))};this._mode=a;break;default:this._p_m_XY=function(b,d){return[b,d]},this._s_m_XY=function(b,d,k=0,p=0){return[b-k,d-p]},this._m_s_XY=function(b,
d,k=0,p=0){return[b+k,d+p]},this._s_m_Angle=this._m_s_Angle=function(b){return this._norm(b)},this._mode=DISPLAY}return this}_reset(){this._stopTurtle();this._taskQueue=[];this._penStack=[];this._clear();this._autoStart=!1;this._lnrSpeed=200;this._angSpeed=X;this._fillColor="white";this._penColor="black";this._penSize=2;this._penA=this._penY=this._penX=0;this._penDown=!0;this._dash=[];this._dashOffset=0;this._penCap=ROUND;this._animate=this._csrVisible=!0;this._fill_points=[];this._fill_track=!1;
this._poly_points=[];this._poly_track=!1;this._record=[];this._recording=!1;this._polygons.clear();this._snapshots.clear();this._tilt=NaN;return this}_update(){if(0==this.nbrTasks)return this._stopTurtle();var a=performance.now();let b=a-this._earlier;this._earlier=a;do a=this._taskQueue[0],b=a.perform(this,b),a.isDONE()&&(a.render&&a.render(this._bdc,this._b.width,this._b.height),this._taskQueue.shift());while(0<this.nbrTasks&&0<b)}_addTask(a){this._taskQueue.push(a);0===this._timer&&this._autoStart&&
this._startTurtle();return this}_injectTasks(a,b=1){this._taskQueue.splice(b,0,...a)}_clear(){this._bdc.clearRect(0,0,this._b.width,this._b.height);return this}_startTurtle(){0===this._timer&&(this._timer=setInterval(()=>this._update.call(this),this._interval),this._earlier=performance.now())}_stopTurtle(){clearInterval(this._timer);this._timer=0}_fix(a){for(this._degrees&&(a=a*e/180);0>a;)a+=v;for(;a>=v;)a-=v;return a}_norm(a){let b=this._degrees?360:v;for(;0>a;)a+=b;for(;a>=b;)a-=b;return a}}class u{constructor(...a){this._info=
a;this.setDONE()}setWAITING(){this._status=64}setREADY(){this._status=65}setDONE(){this._status=128}isWAITING(){return 64===this._status}isREADY(){return 65===this._status}isDONE(){return 128===this._status}clone(){return new this.constructor(...this._info)}recordManager(a){a._recording&&a._record.push(this.clone())}}class C extends u{constructor(...a){super(...a);this._ang=a[0];this._dir=a[1];this.setWAITING()}turnDir(a,b){a=A(a);b=A(b);let d;a=b-a;a>-e&&a<=e?d=a:a>e?d=a-v:a<=-e&&(d=a+v);return n(d)}init(a){this.recordManager(a);
let b=this._dir;var d=this._ang;this._angSpeed=a._angSpeed;a=A(a._penA);d=0===b?d:A(a+b*d);0===b&&(b=this.turnDir(a,d));switch(b){case LT:d>a&&(a+=v);break;case RT:a>d&&(d+=v)}this._sa=a;this._ea=d;this._range=d-a;this._dir=b;this._t=0;this.setREADY()}perform(a,b){this.isWAITING()&&this.init(a);let d=0;a._animate&&0!=this._range?(this._t+=q(this._dir*this._angSpeed*b/1E3/this._range),1<=this._t?(this.setDONE(),d=(this._t-1)*this._range*1E3/this._angSpeed,a._penA=A(this._ea)):(b=this._sa,a._penA=b+
this._t*(this._ea-b))):(this.setDONE(),d=b,a._penA=A(this._ea));return d}}class G extends u{constructor(...a){super(...a);this._length=a[0];this._dir=a[1];this.setWAITING()}init(a){this.recordManager(a);[this._fillStyle,this._strokeStyle,this._penSize,this._penDown]=[a._fillColor,a._penColor,a._penSize,a._penDown];this._lineCap=Symbol.keyFor(a._penCap);this._lineDash=[...a._dash];this._lineDashOffset=a._dashOffset;[this._sx,this._sy,this._ang]=[a._penX,a._penY,a._penA];this._ex=this._sx+this._dir*
this._length*h(this._ang);this._ey=this._sy+this._dir*this._length*r(this._ang);this._tx=this._sx;this._ty=this._sy;this._t=0;this.setREADY()}perform(a,b){this.isWAITING()&&this.init(a);let d=0;a._animate?(this._t+=a._lnrSpeed*b*.001/this._length,1<=this._t?(this.setDONE(),d=(this._t-1)*this._length*1E3/a._lnrSpeed,this._tx=this._ex,this._ty=this._ey):(b=this._sx,this._tx=b+this._t*(this._ex-b),b=this._sy,this._ty=b+this._t*(this._ey-b))):(this._tx=this._ex,this._ty=this._ey,d=b,this.setDONE());a._penX=
this._tx;a._penY=this._ty;this.isDONE()&&(a._fill_track&&a._fill_points.push(["lineTo",a._penDown?"lineTo":"moveTo",a._penX,a._penY]),a._poly_track&&a._poly_points.push(a._m_s_XY(a._penX,a._penY)));return d}render(a,b=0,d=0){!this.isWAITING()&&this._penDown&&(a.save(),a.translate(b/2,d/2),a.fillStyle=this._fillStyle,a.strokeStyle=this._strokeStyle,a.lineWidth=this._penSize,a.lineCap=this._lineCap,a.setLineDash(this._lineDash),a.lineDashOffset=this._lineDashOffset,a.beginPath(),a.moveTo(this._sx,this._sy),
a.lineTo(this._tx,this._ty),a.stroke(),a.restore())}}class Y extends u{constructor(...a){super(...a);this._d=a[0];this._h=a[1];this._side=a[2];this._keepHead=a[3];this._steps=a[4];this.setWAITING()}init(a){var b=this._d,d=this._h;let k=this._side;var p=a._penX;let t=a._penY;a=a._penA;var z=p+b*h(a),H=t+b*r(a);let oa=(p+z)/2,pa=(t+H)/2;var B=Math.sqrt((z-p)**2+(H-t)**2);H=-(H-t)/B;z=(z-p)/B;B=b/2;b=(B*B/d+d)/2;d=b-d;B=2*x(B/d);0>B&&(B+=2*e);p=f(t-(pa-z*k*d),p-(oa-H*k*d));this._orgHead=a;this._head=
A(p-k*e/2);this._extent=B;this._radius=b;this._dir=k==LT?RT:LT;this.setREADY()}perform(a,b){this.isWAITING()&&this.init(a);let d=[];0==this._h?d.push(new G(this._d,N)):(d.push(new C(this._head,D)),0==this._steps?d.push(new R(this._radius,this._radius,this._extent,this._dir)):d.push(new S(this._radius,this._radius,this._extent,this._dir,this._steps)),this._keepHead&&d.push(new C(this._orgHead,D)));a._injectTasks(d);this.setDONE();return b}}class S extends u{constructor(...a){super(...a);this._a=q(a[0]);
this._b=q(a[1]);this._ext=a[2];this._turn=a[3];this._steps=a[4];this.setWAITING()}init(a){this._cx=a._penX-this._turn*this._b*r(a._penA);this._cy=a._penY+this._turn*this._b*h(a._penA);this._angSpeed=a._lnrSpeed*v/K(this._a,this._b);switch(this._turn){case LT:this._ccw=!0;this._sa=y;this._ea=this._sa-this._ext;break;case RT:this._ccw=!1;this._sa=v-y;this._ea=this._sa+this._ext;break;default:console.log("ERROR illegal turn")}this._deltaAngle=this._ext/this._steps;this._era=a._penA;this._ca=this._sa;
this._t=0;this.setREADY()}perform(a,b){this.isWAITING()&&this.init(a);let d=[];for(let k=1;k<=this._steps;k++){this._ca=this._sa+this._turn*this._deltaAngle*k;let [p,t]=L(this._cx,this._cy,this._a,this._b,this._era,this._ca);if(a._mode===LOGO){let z=p;p=t;t=z}d.push(new M(F,p,t))}d.push(new C(A(a._penA+this._turn*this._ext),D));a._injectTasks(d);this.setDONE();return b}}class R extends u{constructor(...a){super(...a);this._a=q(a[0]);this._b=q(a[1]);this._ext=a[2];this._turn=a[3];this._lineDash=[];
this.setWAITING()}init(a){this.recordManager(a);[this._fillStyle,this._strokeStyle,this._lineWidth,this._penDown]=[a._fillColor,a._penColor,a._penSize,a._penDown];this._lineCap=Symbol.keyFor(a._penCap);[this._sx,this._sy,this._penA]=[a._penX,a._penY,a._penA];this._lineDash=[...a._dash];this._lineDashOffset=a._dashOffset;this._cx=this._sx-this._turn*this._b*r(this._penA);this._cy=this._sy+this._turn*this._b*h(this._penA);this._angSpeed=a._lnrSpeed*v/K(this._a,this._b);switch(this._turn){case LT:this._ccw=
!0;this._sa=y;this._ea=this._sa-this._ext;break;case RT:this._ccw=!1;this._sa=v-y;this._ea=this._sa+this._ext;break;default:console.log("ERROR illegal turn")}this._era=a._penA;this._ca=this._sa;this._t=0;this.setREADY()}perform(a,b){this.isWAITING()&&this.init(a);var d=b*this._angSpeed/1E3;this._ca+=d*this._turn;var k=this._sa;this._t=(this._ca-k)/(this._ea-k);1<=this._t||!a._animate?(b=(this._t-1)*this._ext*1E3/this._angSpeed,this._t=1,this._ca=this._ea):b-=1E3*d/this._angSpeed;d=L(this._cx,this._cy,
this._a,this._b,this._era,this._ca);a._penX=d[0];a._penY=d[1];a._penA=A(this._ca+this._era+this._turn*y);if(1<=this._t&&(this.setDONE(),a._fill_track&&a._fill_points.push(["ellipse","ellipse",this._cx,this._cy,this._a,this._b,this._era,this._sa,this._ca,this._ccw]),a._poly_track)){d=g(K(this._a,this._b)*this._ext/(20*v));k=this._ext/d;for(let p=1;p<=d;p++){let t=L(this._cx,this._cy,this._a,this._b,this._era,this._sa+p*k*this._turn);a._poly_points.push(a._m_s_XY(t[0],t[1]))}}return b}render(a,b=0,
d=0){!this.isWAITING()&&this._penDown&&(a.save(),a.translate(b/2,d/2),a.fillStyle=this._fillStyle,a.strokeStyle=this._strokeStyle,a.lineWidth=this._lineWidth,a.lineCap=this._lineCap,a.setLineDash(this._lineDash),a.lineDashOffset=this._lineDashOffset,a.beginPath(),a.ellipse(this._cx,this._cy,this._a,this._b,this._era,this._sa,this._ca,this._ccw),a.stroke(),a.closePath(),a.restore())}}class aa extends u{constructor(...a){super(...a);this._rad=a[0];this._fcol=a[1];this._sw=a[2];this._scol=a[3]}perform(a,
b){this.recordManager(a);[this._sx,this._sy,this._penDown]=[a._penX,a._penY,a._penDown];this._fcol="current"==this._fcol?a._fillColor:this._fcol;this._scol="current"==this._scol?a._penColor:this._scol;this._sw=0<this._sw?Number(this._sw):0==this._sw?a._penSize:0;this._rad=0>=this._rad?m(2*a._penSize,a._penSize+4):this._rad}render(a,b=0,d=0){!this.isWAITING()&&this._penDown&&(a.save(),a.translate(b/2,d/2),0<this._sw&&(a.strokeStyle=this._scol,a.lineWidth=this._sw),a.fillStyle=this._fcol,a.beginPath(),
a.ellipse(this._sx,this._sy,this._rad,this._rad,0,0,v,!0),a.fill(),0<this._sw&&a.stroke(),a.closePath(),a.restore())}}class ba extends u{constructor(...a){super(...a);this._size=a[0];this._fcol=a[1];this._sw=a[2];this._scol=a[3]}perform(a,b){this.recordManager(a);[this._sx,this._sy,this._penDown]=[a._penX,a._penY,a._penDown];this._angle=a._penA;this._fcol="current"==this._fcol?a._fillColor:this._fcol;this._scol="current"==this._scol?a._penColor:this._scol;this._sw=0<this._sw?Number(this._sw):0==this._sw?
a._penSize:0;this._xp=-this._size*h(e/6);this._yp=this._size*r(e/6)}render(a,b=0,d=0){!this.isWAITING()&&this._penDown&&(a.save(),a.translate(b/2,d/2),a.translate(this._sx,this._sy),a.rotate(this._angle),a.fillStyle=this._fcol,0<this._sw&&(a.strokeStyle=this._scol,a.lineWidth=this._sw),a.beginPath(),a.moveTo(0,0),a.lineTo(this._xp,this._yp),a.lineTo(this._xp,-this._yp),a.lineTo(0,0),a.fill(),0<this._sw&&a.stroke(),a.closePath(),a.restore())}}class da extends u{constructor(...a){super(...a);this._text=
a[0];this._align=a[1];this._move=a[2];this._font=a[3];this.setWAITING()}init(a){this.recordManager(a);[this._sx,this._sy,this._pa,this._fillColor,this._mode,this._penDown]=[a._penX,a._penY,a._penA,a._fillColor,a._mode,a._penDown];switch(this._align){case "right":case RT:this._align="right";break;case "center":case CT:this._align="center";break;default:this._align="left"}this._font=this._font??a._font;this.setREADY()}perform(a,b){this.isWAITING()&&this.init(a);if(this._move&&"right"!==this._align){a._bdc.font=
this._font;var d=a._bdc.measureText(this._text).width;"center"===this._align&&(d/=2);b=d*r(a._penA);d*=h(a._penA);switch(this._mode){case LOGO:a._penX=this._sx-b;a._penY=this._sy+d;break;case STANDARD:a._penX=this._sx+b;a._penY=this._sy-d;break;case DISPLAY:a._penX=this._sx-b,a._penY=this._sy+d}}this.setDONE()}render(a,b=0,d=0){!this.isWAITING()&&this._penDown&&(a.save(),a.translate(this._sx+b/2,this._sy+d/2),a.font=this._font,a.textAlign=this._align,a.textBaseline="bottom",a.fillStyle=this._fillColor,
a.rotate(this._pa+y),this._mode===STANDARD&&(a.rotate(-e),a.scale(1,-1)),a.fillText(this._text,0,0),a.restore())}}class T extends u{constructor(...a){super(...a);this._action=a[0];this._what=a[1]}perform(a,b){this.recordManager(a);let d;switch(this._action){case P:d={style:[a._penDown,a._penSize,[...a._dash],a._dashOffset,a._penCap,a._penColor,a._fillColor,a._animate,a._csrVisible,a._tilt,a._lnrSpeed,a._angSpeed],position:[a._penX,a._penY,a._penA]};a._penStack.push(d);break;case Q:0<a.nbrStyles&&
(d=a._penStack.pop(),STYLE==(this._what&STYLE)&&([a._penDown,a._penSize,a._dash,a._dashOffset,a._penCap,a._penColor,a._fillColor,a._animate,a._csrVisible,a._tilt,a._lnrSpeed,a._angSpeed]=d.style),POS===(this._what&POS)&&([a._penX,a._penY,a._penA]=d.position))}return b}}class ha extends u{constructor(...a){super(...a)}perform(a,b){a._record=[];a._recording=!0;return b}}class ia extends u{constructor(...a){super(...a);this._id=String(a[0])}perform(a,b){0<this._id.length&&!E.hasRecord(this._id)&&E.setRecord(this._id,
a._record);a._recording=!1;a._record=[];return b}}class ka extends u{constructor(...a){super(...a);this._id=a[0]}perform(a,b){let d=E.getRecord(this._id);d&&a._injectTasks(d);return b}}class ea extends u{constructor(...a){super(...a)}perform(a,b){this.recordManager(a);a._poly_track=!0;a._poly_points=[];a._poly_points.push(a._m_s_XY(a._penX,a._penY));return b}}class fa extends u{constructor(...a){super(...a);this._id=a[0]}perform(a,b){this.recordManager(a);"string"===typeof this._id&&0<this._id.length&&
(a._polygons.set(this._id,a._poly_points),a._poly_track=!1,a._poly_points=[]);this.setDONE();return b}}class U extends u{constructor(...a){super(...a)}perform(a,b){this.recordManager(a);a._fill_track=!0;a._fill_points=[];a._fill_points.push(["moveTo","moveTo",a._penX,a._penY]);return b}}class V extends u{constructor(...a){super(...a);this._close=a[0];this._pts=[];this.setWAITING()}init(a){this.recordManager(a);[this._fillStyle,this._strokeStyle,this._lineWidth,this._penDown]=[a._fillColor,a._penColor,
a._penSize,a._penDown];[this._lineDash,this._lineCap]=[a._dash,Symbol.keyFor(a._penCap)];this._lineDashOffset=a._dashOffset;this._pts=a._fill_points;this._close&&0<this._pts.length&&this._pts.push(["lineTo",a._penDown?"lineTo":"moveTo",this._pts[0][2],this._pts[0][3]]);this.setREADY()}perform(a,b){this.isWAITING()&&this.init(a);a._fill_track=!1;a._fill_points=[];this.setDONE();return b}render(a,b=0,d=0){if(!this.isWAITING()){a.save();a.translate(b/2,d/2);a.fillStyle=this._fillStyle;a.strokeStyle=
this._strokeStyle;a.lineDashOffset=this._lineDashOffset;a.lineWidth=this._lineWidth;a.lineCap=this._lineCap;b=[...this._pts];for(a.beginPath();0<b.length;)d=b.shift(),a[d[0]](...d.slice(2));a.fill();if(this._penDown){b=[...this._pts];a.beginPath();a.setLineDash(this._lineDash);for(a.lineDashOffset=this._lineDashOffset;0<b.length;)d=b.shift(),a[d[1]](...d.slice(2));a.stroke()}a.restore()}}}class Z extends u{constructor(...a){super(...a);this.setWAITING()}init(a){[this._sx,this._sy]=[a._penX,a._penY];
this._angle=f(-this._sy,-this._sx);this._angle=A(this._angle);this._dist=Math.sqrt((0-this._sx)**2+(0-this._sy)**2);this.setREADY()}perform(a,b){this.isWAITING()&&this.init(a);let d=[new C(this._angle,D),new G(this._dist,1),new C(0,D)];a._injectTasks(d);this.setDONE();return b}}class M extends u{constructor(...a){super(...a);this._mt=a[0];this._x=a[1];this._y=a[2];this.setWAITING()}init(a){let [b,d]=[a._penX,a._penY],[k,p]=a._mode==LOGO?[this._y,this._x]:[this._x,this._y];k+=this._mt*a._penX;p+=this._mt*
a._penY;this._angle=A(f(p-d,k-b));this._dist=Math.sqrt((k-b)**2+(p-d)**2);this.setREADY()}perform(a,b){this.isWAITING()&&this.init(a);let d=[new C(this._angle,D),new G(this._dist,1)];a._injectTasks(d);this.setDONE();return b}}class J extends u{constructor(...a){super(...a);this._mt=a[0];this._x=a[1];this._y=a[2];this._fill_gap=a[3]}perform(a,b){let [d,k]=a._mode==LOGO?[this._y,this._x]:[this._x,this._y];d=isNaN(d)?a._penX:d;k=isNaN(k)?a._penY:k;d+=this._mt*a._penX;k+=this._mt*a._penY;let p=[];a.isFilling&&
!this._fill_gap?p.push(new V,new w("_penX",d),new w("_penY",k),new U):(p.push(new w("_penX",d),new w("_penY",k)),a._fill_track&&a._fill_points.push(["lineTo","moveTo",d,k]),a._poly_track&&a._poly_points.push(a._m_s_XY(d,k)));a._injectTasks(p);return b}}class w extends u{constructor(...a){super(...a);this._attr=a[0];this._value=a[1]}perform(a,b){this.recordManager(a);a[`${this._attr}`]=this._value;return b}}class la extends u{constructor(...a){super(...a)}perform(a,b){this.recordManager(a);a._clear();
return b}}class ma extends u{constructor(...a){super(...a)}perform(a,b){this.recordManager(a);a._reset();return b}}class na extends u{constructor(...a){super(...a);this._id=a[0]}perform(a,b){this.recordManager(a);"string"===typeof this._id&&0<this._id.length&&a._snapshots.set(this._id,a._getCopy());this.setDONE();return b}}class ca extends u{constructor(...a){super(...a);this._sleepTimeLeft=a[0];this.setREADY()}perform(a,b){this.recordManager(a);a._animate?b>=this._sleepTimeLeft?(b-=this._sleepTimeLeft,
this.setDONE()):(this._sleepTimeLeft-=b,b=0):this.setDONE();return b}}class ja extends u{constructor(...a){super(...a);this._function=a[0];this._data=a.slice(1)}perform(a,b){this.recordManager(a);this._function(a,...this._data);return b}}return[E]}();function getImageFromOsc(e,q=p5.instance){if(e){let f=e.getContext("2d").getImageData(0,0,e.width,e.height).data,g=new Uint32Array(f);e=q.createImage(e.width,e.height);e.loadPixels();e.pixels.forEach((h,m,n)=>n[m]=g[m]);e.updatePixels();return e}}
function getCursorFromImage(e,q=0,f=0){e.loadPixels();var g=e.width;let h=e.height;e=new ImageData(new Uint8ClampedArray(e.pixels),g,h);g=new OffscreenCanvas(g,h);g.getContext("2d").putImageData(e,0,0);return new Cursor(g,q,f)}
const getArray2D=function(e=1,q=1,f=0){e=Array(e);for(var g=0;g<e.length;g++)e[g]=Array(q);for(q=0;q<e.length;q++)for(g=0;g<e[q].length;g++)e[q][g]=f;return e},[rgb,hsl,hwb,rgb_hsl,hsl_rgb,rgb_hwb,hwb_rgb]=function(){const e=function(f,g,h){function m(r){r=(r+f/30)%12;return h-g*Math.min(h,1-h)*Math.max(-1,Math.min(r-3,9-r,1))}f%=360;0>f&&(f+=360);g/=100;h/=100;let n=[m(0),m(8),m(4)];n.forEach(function(r,l,x){x[l]=1==r?255:Math.floor(256*r)});return n},q=function(f,g,h){f/=255;g/=255;h/=255;let m=
Math.max(f,g,h);var n=Math.min(f,g,h);let [r,l,x]=[NaN,0,(n+m)/2];n=m-n;if(0!==n){l=0===x||1===x?0:(m-x)/Math.min(x,1-x);switch(m){case f:r=(g-h)/n+(g<h?6:0);break;case g:r=(h-f)/n+2;break;case h:r=(f-g)/n+4}r*=60}0>l&&(r+=180,l=Math.abs(l));360<=r&&(r-=360);return[r,100*l,100*x]};return[(f=255,g=255,h=255,m=1)=>`rgb(${f} ${g} ${h} / ${m})`,(f=0,g=100,h=100,m=1)=>`hsl(${f} ${g} ${h} / ${m})`,(f=0,g=70,h=20,m=1)=>`hwb(${f} ${g} ${h} / ${m})`,q,e,function(f,g,h){f/=255;g/=255;h/=255;return[q(f,g,h)[0],
100*Math.min(f,g,h),100*(1-Math.max(f,g,h))]},function(f,g,h){g/=100;h/=100;if(1<=g+h)return g/=g+h,[g,g,g];f=e(f,100,50);f[1]/=255;f[2]/=255;for(let m=0;3>m;m++)f[m]*=1-g-h,f[m]+=g;f.forEach(function(m,n,r){r[n]=1==m?255:Math.floor(256*m)});return f}]}(),dp0$=Intl.NumberFormat(void 0,{useGrouping:!1,minimumFractionDigits:0,maximumFractionDigits:0}).format,dp1$=Intl.NumberFormat(void 0,{useGrouping:!1,minimumFractionDigits:1,maximumFractionDigits:1}).format,dp3$=Intl.NumberFormat(void 0,{useGrouping:!1,
minimumFractionDigits:3,maximumFractionDigits:3}).format,deg1$=function(e){return dp1$(360*e/Math.PI)};function printPoly(e,q){q=e.getPoly(q);console.log("-----------------------------------------------------------------");console.log(`MODE: ${e.getMode()}         Nbr. Points ${q?.length??0}`);q?.forEach(f=>{console.log(`  [${dp0$(f[0])}, ${dp0$(f[1])}]`)})}
class Cursor{constructor(e,q,f){this._icon=e;this._hx=q*e.width;this._hy=f*e.height}get icon(){return this._icon}get hitX(){return this._hx}get hitY(){return this._hy}}const [ARROW,BALL,DART,DIAMOND,HEXAGON,STAR,TRIANGLE,TURTLE]=function(){let e=[];e.push(csrARROW(20));e.push(csrBALL(10));e.push(csrDART(20));e.push(csrDIAMOND(20));e.push(csrHEXAGON(20));e.push(csrSTAR(24));e.push(csrTRIANGLE(20));e.push(csrTURTLE(24,"limegreen","burlywood",1.5,"saddlebrown"));return e}();
function csrARROW(e,q="greenyellow",f=1,g="black"){e=__csrFromVertices(e,.1,[1,4,1,6,5,6,5,8,9,5,5,2,5,4],q,f,g);return new Cursor(e,.5,.5)}function csrBALL(e,q="greenyellow",f=1,g="black"){let h=e/2,m=new OffscreenCanvas(e,e),n=m.getContext("2d");n.clearRect(0,0,e,e);n.fillStyle=q;n.strokeStyle=g;n.lineWidth=f;n.beginPath();n.translate(h,h);n.ellipse(0,0,h,h,0,0,2*Math.PI);n.fill();0<f&&n.stroke();n.closePath();return new Cursor(m,.5,.5)}
function csrDART(e,q="greenyellow",f=1,g="black"){c=[1,1,4,5,1,9,9,5];e=__csrFromVertices(e,.1,c,q,f,g);return new Cursor(e,.5,.5)}function csrDIAMOND(e,q="greenyellow",f=1,g="black"){e=__csrFromVertices(e,.05,[5,10,10,19,15,10,10,1],q,f,g);return new Cursor(e,.5,.5)}
function csrHEXAGON(e,q="greenyellow",f=1,g="black"){nbrSides=6;let h=2*Math.PI/nbrSides,m=[];for(let n=0;n<nbrSides;n++)m.push(.95*Math.cos(n*h)),m.push(.95*Math.sin(n*h));e=__csrFromVertices(e,.5,m,q,f,g,[.5,.5]);return new Cursor(e,.5,.5)}function csrSTAR(e,q="greenyellow",f=1,g="black"){nbrPts=5;let h=Math.PI/nbrPts,m=[];for(let n=0;n<2*nbrPts;n++){let r=0==n%2?.95:.25;m.push(r*Math.cos(n*h));m.push(r*Math.sin(n*h))}e=__csrFromVertices(e,.5,m,q,f,g,[.5,.5]);return new Cursor(e,.5,.5)}
function csrTRIANGLE(e,q="greenyellow",f=1,g="black"){e=__csrFromVertices(e,.1,[3,2,3,8,9,5],q,f,g);return new Cursor(e,.5,.5)}
function csrTURTLE(e,q="limegreen",f="burlywood",g=1,h="saddlebrown"){var m=e/2,n=g/3;let r=new OffscreenCanvas(e,e),l=r.getContext("2d");l.clearRect(0,0,e,e);l.translate(m,m);m=.27*e;var x=.2*e,y=31*Math.PI/180;l.fillStyle=q;l.strokeStyle=h;l.lineWidth=n;l.beginPath();l.ellipse(-m,x,.2*e,.08*e,-y,0,2*Math.PI);l.ellipse(-m,-x,.2*e,.08*e,y,0,2*Math.PI);l.fill();l.stroke();m=.1*e;x=.2*e;y=0*Math.PI/180;l.beginPath();l.ellipse(m,x,.08*e,.2*e,-y,0,2*Math.PI);l.ellipse(m,-x,.08*e,.2*e,y,0,2*Math.PI);l.fill();
l.stroke();l.beginPath();l.ellipse(-.37*e,0,.2*e,.05*e,0,0,2*Math.PI);l.fill();l.stroke();l.beginPath();l.ellipse(.3*e,0,.175*e,.125*e,0,0,2*Math.PI);l.fill();l.stroke();q=-.05*e;m=.35*e;x=.25*e;l.fillStyle=f;l.strokeStyle=h;l.lineWidth=g;l.beginPath();l.ellipse(q,0,m,x,0,0,2*Math.PI);l.fill();l.stroke();f=getArray2D(6,2);g=getArray2D(6,2);e*=.13;for(h=0;h<f.length;h++){var v=(30+60*h)*Math.PI/180;y=Math.sin(v);v=Math.cos(v);f[h][0]=q+e*v;f[h][1]=e*y;g[h][0]=q+m*v;g[h][1]=x*y}l.lineWidth=n;l.beginPath();
for(n=0;n<f.length;n++)l.moveTo(g[n][0],g[n][1]),l.lineTo(f[n][0],f[n][1]);for(n=0;n<f.length;n++)l.lineTo(f[n][0],f[n][1]);l.stroke();return new Cursor(r,.5,.5)}
function __csrFromVertices(e,q,f,g,h=0,m="transparent",n=[0,0]){f=f.map(x=>x*q*e);let r=new OffscreenCanvas(e,e),l=r.getContext("2d");l.clearRect(0,0,e,e);l.translate(e*n[0],e*n[1]);l.fillStyle=g;l.strokeStyle=m;l.lineWidth=h;g=f.shift();m=f.shift();l.beginPath();for(l.moveTo(g,m);2<=f.length;)l.lineTo(f.shift(),f.shift());l.lineTo(g,m);l.fill();0<h&&l.stroke();l.closePath();return r};
